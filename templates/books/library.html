{% extends 'base.html' %}
{% load static %}

{% block title %}Biblioteca Comunitária{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/library.css' %}">
{% endblock %}

{% block content %}
<div class="library-container">
    <!-- HEADER -->
    <header class="library-header">
        <div class="header-content">
            <div class="header-main">
                <h1>Biblioteca Comunitária</h1>
                <p class="header-subtitle">Descubra livros incríveis compartilhados pela comunidade</p>
            </div>
            <div class="header-stats">
                <div class="stat-badge">
                    <span class="stat-number">{{ books|length }}</span>
                    <span class="stat-label">livro{{ books|length|pluralize }}</span>
                </div>
            </div>
        </div>
    </header>

    <!-- FILTROS -->
    <section class="filters-section">
        <div class="filters-toggle">
            <button class="filters-toggle-btn" id="toggleFilters">
                <i class="fas fa-filter"></i>
                <span>Filtros</span>
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>

        <div class="filters-container" id="filtersContainer">
            <form method="GET" action="" class="filters-form">
                <div class="filters-grid">
                    <!-- Título -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-book"></i>
                            Título
                        </label>
                        <input type="text" 
                               class="filter-input" 
                               name="title" 
                               placeholder="Buscar por título..."
                               value="{{ request.GET.title|default:'' }}">
                    </div>

                    <!-- Autor -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-user"></i>
                            Autor
                        </label>
                        <input type="text" 
                               class="filter-input" 
                               name="author" 
                               placeholder="Buscar por autor..."
                               value="{{ request.GET.author|default:'' }}">
                    </div>

                    <!-- Categoria -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-tag"></i>
                            Categoria
                        </label>
                        <select class="filter-select" name="category">
                            <option value="">Todas as categorias</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    {% if request.GET.category == category.id|stringformat:"i" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-circle"></i>
                            Status
                        </label>
                        <select class="filter-select" name="status">
                            <option value="">Todos os status</option>
                            <option value="available" {% if request.GET.status == 'available' %}selected{% endif %}>
                                Disponível
                            </option>
                            <option value="borrowed" {% if request.GET.status == 'borrowed' %}selected{% endif %}>
                                Emprestado
                            </option>
                            <option value="reserved" {% if request.GET.status == 'reserved' %}selected{% endif %}>
                                Reservado
                            </option>
                        </select>
                    </div>

                    <!-- Ordenação -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-sort"></i>
                            Ordenar por
                        </label>
                        <select class="filter-select" name="order_by">
                            <option value="newest" {% if request.GET.order_by == 'newest' %}selected{% endif %}>
                                Mais recentes
                            </option>
                            <option value="popular" {% if request.GET.order_by == 'popular' %}selected{% endif %}>
                                Mais populares
                            </option>
                            <option value="title_asc" {% if request.GET.order_by == 'title_asc' %}selected{% endif %}>
                                Título (A-Z)
                            </option>
                            <option value="title_desc" {% if request.GET.order_by == 'title_desc' %}selected{% endif %}>
                                Título (Z-A)
                            </option>
                        </select>
                    </div>
 
                    <!-- Condição -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-star"></i>
                            Condição
                        </label>
                        <select class="filter-select" name="condition">
                            <option value="">Todas as condições</option>
                            <option value="new" {% if request.GET.condition == 'nw' %}selected{% endif %}>
                                Novo
                            </option>
                            <option value="good" {% if request.GET.condition == 'gd' %}selected{% endif %}>
                                Bom
                            </option>
                            <option value="regular" {% if request.GET.condition == 'fr' %}selected{% endif %}>
                                Preservado
                            </option>
                            <option value="regular" {% if request.GET.condition == 'dm' %}selected{% endif %}>
                                Danificado
                            </option>
                        </select>
                    </div>
                </div>

                <div class="filters-actions">
                    <button type="submit" class="minimal-btn primary">
                        <i class="fas fa-search"></i>
                        Aplicar filtros
                    </button>
                    
                    {% if request.GET.title or request.GET.author or request.GET.category or request.GET.status or request.GET.order_by or request.GET.condition %}
                    <a href="?" class="minimal-btn">
                        <i class="fas fa-times"></i>
                        Limpar filtros
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </section>

    <!-- TAGS ATIVAS -->
    {% if request.GET.title or request.GET.author or request.GET.category or request.GET.status or request.GET.order_by or request.GET.condition %}
    <div class="active-filters">
        <div class="active-filters-header">
            <span>Filtros ativos:</span>
        </div>
        <div class="active-filters-tags">
            {% if request.GET.title %}
            <span class="active-filter-tag">
                Título: {{ request.GET.title }}
                <a href="?{{ request.GET.urlencode|cut:'&title='|cut:'title='|cut:'&' }}" class="remove-filter">
                    <i class="fas fa-times"></i>
                </a>
            </span>
            {% endif %}
            
            {% if request.GET.author %}
            <span class="active-filter-tag">
                Autor: {{ request.GET.author }}
                <a href="?{{ request.GET.urlencode|cut:'&author='|cut:'author='|cut:'&' }}" class="remove-filter">
                    <i class="fas fa-times"></i>
                </a>
            </span>
            {% endif %}
            
            {% if request.GET.category %}
            <span class="active-filter-tag">
                Categoria: {{ request.GET.category }}
                <a href="?{{ request.GET.urlencode|cut:'&category='|cut:'category='|cut:'&' }}" class="remove-filter">
                    <i class="fas fa-times"></i>
                </a>
            </span>
            {% endif %}
            
            {% if request.GET.status %}
            <span class="active-filter-tag">
                Status: {{ request.GET.status|title }}
                <a href="?{{ request.GET.urlencode|cut:'&status='|cut:'status='|cut:'&' }}" class="remove-filter">
                    <i class="fas fa-times"></i>
                </a>
            </span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- NOVA SEÇÃO: CATEGORIAS POPULARES -->
    <section class="categories-section">
        <h2>Categorias populares</h2>
        <div class="categories-grid">
            <a href="?category=1" class="category-card">
                <div class="category-icon">
                    <i class="fas fa-wizard"></i>
                </div>
                <div class="category-info">
                    <h3>Fantasia</h3>
                    <span class="category-count">142 livros</span>
                </div>
            </a>
            
            <a href="?category=2" class="category-card">
                <div class="category-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="category-info">
                    <h3>Romance</h3>
                    <span class="category-count">98 livros</span>
                </div>
            </a>
            
            <a href="?category=3" class="category-card">
                <div class="category-icon">
                    <i class="fas fa-microscope"></i>
                </div>
                <div class="category-info">
                    <h3>Ficção Científica</h3>
                    <span class="category-count">76 livros</span>
                </div>
            </a>
            
            <a href="?category=4" class="category-card">
                <div class="category-icon">
                    <i class="fas fa-landmark"></i>
                </div>
                <div class="category-info">
                    <h3>História</h3>
                    <span class="category-count">54 livros</span>
                </div>
            </a>
        </div>
    </section>

    <!-- GRID DE LIVROS -->
    {% if books %}
    <section class="books-section">
        <div class="books-grid">
            {% for book in books %}
            <a href="{{ book.get_absolute_url }}" class="book-card">
                <div class="book-card-cover">
                    {% if book.cover_image %}
                    <img src="{{ book.cover_image.url }}" alt="Capa de {{ book.title }}" class="book-cover-image">
                    {% elif book.cover_url %}
                    <img src="{{ book.cover_url }}" alt="Capa de {{ book.title }}" class="book-cover-image">
                    {% else %}
                    <div class="cover-placeholder">
                        <span>{{ book.title|slice:":2"|upper }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="book-badges">
                        <span class="book-status {% if book.status == 'available' %}available{% elif book.status == 'borrowed' %}borrowed{% else %}reserved{% endif %}">
                            {% if book.status == 'available' %}
                                <i class="fas fa-check-circle"></i> Disponível
                            {% elif book.status == 'borrowed' %}
                                <i class="fas fa-clock"></i> Emprestado
                            {% else %}
                                <i class="fas fa-user-clock"></i> Reservado
                            {% endif %}
                        </span>
                        
                        {% if book.condition %}
                        <span class="book-condition {% if book.condition == 'new' %}new{% elif book.condition == 'good' %}good{% else %}regular{% endif %}">
                            {% if book.condition == 'new' %}
                                <i class="fas fa-star"></i> Novo
                            {% elif book.condition == 'good' %}
                                <i class="fas fa-thumbs-up"></i> Boa
                            {% else %}
                                <i class="fas fa-check"></i> Regular
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="book-card-info">
                    <h3 class="book-title">{{ book.title|truncatechars:40 }}</h3>
                    
                    {% if book.author %}
                    <p class="book-author">{{ book.author|truncatechars:30 }}</p>
                    {% endif %}
                    
                    <div class="book-meta">
                        <span class="meta-item">
                            <i class="fas fa-user-circle"></i>
                            {{ book.owner.first_name|default:book.owner.username|truncatechars:15 }}
                        </span>
                        
                        {% if book.distance %}
                        <span class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ book.distance }}km
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if book.categories.all %}
                    <div class="book-categories">
                        {% for category in book.categories.all|slice:":2" %}
                        <span class="category-tag">{{ category.name }}</span>
                        {% endfor %}
                        {% if book.categories.all|length > 2 %}
                        <span class="category-tag">+{{ book.categories.all|length|add:"-2" }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="book-card-footer">
                    <span class="view-details">
                        Ver detalhes
                        <i class="fas fa-arrow-right"></i>
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <!-- ESTADO VAZIO -->
    <section class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-book-open"></i>
        </div>
        
        <div class="empty-content">
            <h2>
                {% if request.GET.title or request.GET.author or request.GET.category or request.GET.status or request.GET.order_by or request.GET.condition %}
                Nenhum livro encontrado
                {% else %}
                Biblioteca vazia
                {% endif %}
            </h2>
            
            <p>
                {% if request.GET.title or request.GET.author or request.GET.category or request.GET.status or request.GET.order_by or request.GET.condition %}
                Não encontramos livros com os filtros aplicados. Tente outros critérios de busca.
                {% else %}
                Ainda não há livros cadastrados na plataforma. Seja o primeiro a compartilhar!
                {% endif %}
            </p>
            
            <div class="empty-actions">
                {% if request.GET.title or request.GET.author or request.GET.category or request.GET.status or request.GET.order_by or request.GET.condition %}
                <a href="?" class="minimal-btn primary">
                    <i class="fas fa-times"></i>
                    Limpar filtros
                </a>
                {% endif %}
                
                {% if user.is_authenticated %}
                <a href="{% url 'books:create' %}" class="minimal-btn">
                    <i class="fas fa-plus"></i>
                    Cadastrar livro
                </a>
                {% else %}
                <a href="{% url 'account_login' %}" class="minimal-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    Fazer login
                </a>
                {% endif %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- NOVA SEÇÃO: LEITORES ATIVOS -->
    <section class="readers-section">
        <div class="section-header">
            <h2>Leitores ativos</h2>
            <a href="#" class="view-more">Ver todos</a>
        </div>
        
        <div class="readers-grid">
            <div class="reader-card">
                <div class="reader-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="reader-info">
                    <h3>Ana Silva</h3>
                    <p class="reader-location">
                        <i class="fas fa-map-marker-alt"></i>
                        São Paulo, SP
                    </p>
                    <div class="reader-stats">
                        <span class="stat">
                            <i class="fas fa-book"></i>
                            24 livros
                        </span>
                        <span class="stat">
                            <i class="fas fa-exchange-alt"></i>
                            18 trocas
                        </span>
                    </div>
                </div>
                <a href="#" class="reader-profile">
                    Ver perfil
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            
            <div class="reader-card">
                <div class="reader-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="reader-info">
                    <h3>Carlos Santos</h3>
                    <p class="reader-location">
                        <i class="fas fa-map-marker-alt"></i>
                        Rio de Janeiro, RJ
                    </p>
                    <div class="reader-stats">
                        <span class="stat">
                            <i class="fas fa-book"></i>
                            31 livros
                        </span>
                        <span class="stat">
                            <i class="fas fa-exchange-alt"></i>
                            26 trocas
                        </span>
                    </div>
                </div>
                <a href="#" class="reader-profile">
                    Ver perfil
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            
            <div class="reader-card">
                <div class="reader-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="reader-info">
                    <h3>Beatriz Lima</h3>
                    <p class="reader-location">
                        <i class="fas fa-map-marker-alt"></i>
                        Belo Horizonte, MG
                    </p>
                    <div class="reader-stats">
                        <span class="stat">
                            <i class="fas fa-book"></i>
                            19 livros
                        </span>
                        <span class="stat">
                            <i class="fas fa-exchange-alt"></i>
                            15 trocas
                        </span>
                    </div>
                </div>
                <a href="#" class="reader-profile">
                    Ver perfil
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle filters
    const toggleBtn = document.getElementById('toggleFilters');
    const filtersContainer = document.getElementById('filtersContainer');
    
    if (toggleBtn && filtersContainer) {
        toggleBtn.addEventListener('click', function() {
            filtersContainer.classList.toggle('show');
            const icon = this.querySelector('.fa-chevron-down');
            if (icon) {
                icon.classList.toggle('rotated');
            }
        });
    }
    
    // Remove individual filter tags
    document.querySelectorAll('.remove-filter').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = this.getAttribute('href');
        });
    });
    
    // Book card hover effects
    document.querySelectorAll('.book-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}